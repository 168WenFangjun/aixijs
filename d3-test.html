<!DOCTYPE html>
<meta charset='utf-8'>
<style>

.link {
fill: none;
stroke: blue;
}

</style>
<svg width='960' height='600'></svg>
<script src='external/d3-4.2.6.min.js'></script>
<script>

// https://bl.ocks.org/mbostock/4600693

let svg = d3.select('svg');
let width = svg.attr('width');
let height = svg.attr('height');

let color = d3.scaleOrdinal(d3.schemeCategory20);
let simulation = d3.forceSimulation();
simulation.force('link', d3.forceLink().distance(100).strength(0.1));
simulation.force('charge', d3.forceManyBody());
simulation.force('center', d3.forceCenter(width / 2, height / 2));

let graph = {
  nodes: [
{ id: 'Myriel'},
{ id: 'Napoleon' },
{ id: 'Gangsta' },
],
links: [
{ source: 'Napoleon', target: 'Myriel', value: 1 },
{ source: 'Myriel', target: 'Gangsta', value: 1 },
{ source: 'Myriel', target: 'Myriel', value: 1 },
],
};

/////////////////
var nodes = graph.nodes,
nodeById = d3.map(nodes, function(d) { return d.id; }),
links = graph.links,
bilinks = [];

links.forEach(function(link) {
  let s = link.source = nodeById.get(link.source)
  let t = link.target = nodeById.get(link.target)
  let i = {}; // intermediate node
  nodes.push(i);
  if (s == t) {
    j = {};
    nodes.push(j);
    links.push(
        {source: s, target: i},
        {source: i, target: j},
        {source: j, target: t});
    bilinks.push([s, i, j, s]);
    //bilinks.push([j, i, s]);
  } else {
    links.push({source: s, target: i}, {source: i, target: t});
    bilinks.push([s, i, t]);
  }
});

var link = svg.selectAll('.link')
.data(bilinks)
.enter().append('path')
.attr('class', 'link');

var node = svg.selectAll('.node')
.data(nodes.filter(function(d) { return d.id; }))
.enter().append('circle')
.attr('class', 'node')
.attr('r', 30)
.attr('fill', function(d) { return color(d.group); })
.call(d3.drag()
.on('start', dragstarted)
.on('drag', dragged)
.on('end', dragended));

node.append('title')
.text(function(d) { return d.id; });

simulation.nodes(nodes)
.on('tick', ticked);

simulation.force('link')
.links(links);

function ticked() {
link.attr('d', positionLink);
node.attr('transform', positionNode);
}

function positionLink(d) {
  let curve = 'S'
  if (d.length == 4 ) {
    curve = 'C'
  }
  let s = `M${d[0].x},${d[0].y}${curve}${d[1].x},${d[1].y} ${d[2].x},${d[2].y}`
  if (d.length == 4) {
    s += ` ${d[3].x},${d[3].y}`
  }
  return s;
}

function positionNode(d) {
return 'translate(' + d.x + ',' + d.y + ')';
}

function dragstarted(d) {
if (!d3.event.active) simulation.alphaTarget(0.3).restart();
d.fx = d.x, d.fy = d.y;
}

function dragged(d) {
d.fx = d3.event.x, d.fy = d3.event.y;
}

function dragended(d) {
if (!d3.event.active) simulation.alphaTarget(0);
d.fx = null, d.fy = null;
}

</script>
